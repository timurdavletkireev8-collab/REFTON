<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RefTON ‚Äî Earn with referrals</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Adsgram SDK -->
    <script src="https://sdk.adsgram.ai/js/adsgram.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #03050B 0%, #0A0F1F 100%);
            min-height: 100vh;
            color: white;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: rgba(20, 30, 50, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 60px;
            padding: 8px 16px;
            border: 1px solid rgba(77, 126, 255, 0.2);
        }
        
        .logo {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        .logo span:first-child { color: #4D7EFF; }
        .logo span:last-child { color: #00FFA3; }
        
        .balance {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 40px;
            padding: 4px 12px 4px 4px;
            border: 1px solid rgba(77, 126, 255, 0.3);
        }
        
        .balance-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4D7EFF, #00FFA3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .balance-amount {
            font-size: 18px;
            font-weight: 600;
        }
        
        .balance-small {
            font-size: 12px;
            color: #8E9AB0;
            margin-left: 4px;
        }
        
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }
        
        .nav-item {
            background: rgba(20, 30, 50, 0.5);
            backdrop-filter: blur(5px);
            border-radius: 16px;
            padding: 12px 4px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #8E9AB0;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .nav-item.active {
            background: rgba(77, 126, 255, 0.2);
            border-color: #4D7EFF;
            color: white;
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .section-container {
            flex: 1;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glass-card {
            background: rgba(20, 30, 50, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(77, 126, 255, 0.2);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .refton-button {
            background: linear-gradient(135deg, #4D7EFF 0%, #00FFA3 100%);
            border: none;
            border-radius: 60px;
            padding: 16px 24px;
            font-weight: 600;
            font-size: 17px;
            color: white;
            box-shadow: 0 8px 20px rgba(77, 126, 255, 0.4);
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .refton-button:active {
            transform: scale(0.97);
        }
        
        .refton-button-outline {
            background: transparent;
            border: 2px solid #4D7EFF;
            color: #4D7EFF;
            box-shadow: none;
        }
        
        .refton-button-outline:active {
            background: rgba(77, 126, 255, 0.1);
        }
        
        .hidden { display: none; }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 16px;
            right: 16px;
            background: rgba(20, 30, 50, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #4D7EFF;
            border-radius: 60px;
            padding: 16px;
            text-align: center;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .section-image {
            width: 100%;
            max-width: 100px;
            height: auto;
            margin: 0 auto 20px;
            display: block;
            filter: drop-shadow(0 10px 20px rgba(77, 126, 255, 0.3));
        }
        
        .cooldown-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #FFA500;
            font-size: 14px;
            margin: 16px 0;
            padding: 12px;
            background: rgba(255, 165, 0, 0.1);
            border-radius: 40px;
            border: 1px solid #FFA500;
        }
        
        .rank-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }
        
        .rank-bronze { background: #8B5A2B; color: #FFD700; }
        .rank-silver { background: #4A5568; color: #E2E8F0; }
        .rank-gold { background: #B8860B; color: #FFD700; }
        .rank-platinum { background: #2C3E50; color: #E5E4E2; }
        .rank-diamond { background: #0F4C81; color: #B9F2FF; }
        
        .referral-link-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(77, 126, 255, 0.3);
            border-radius: 12px;
            padding: 12px;
            font-size: 14px;
            word-break: break-all;
            margin: 16px 0;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stats-row:last-child {
            border-bottom: none;
        }
        
        .language-selector {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .lang-btn {
            background: rgba(20, 30, 50, 0.5);
            border: 1px solid rgba(77, 126, 255, 0.3);
            border-radius: 40px;
            padding: 8px 24px;
            color: #8E9AB0;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .lang-btn.active {
            background: #4D7EFF;
            color: white;
            border-color: #4D7EFF;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: #0A0F1F;
            border: 2px solid #4D7EFF;
            border-radius: 32px;
            padding: 32px;
            max-width: 300px;
            text-align: center;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #4D7EFF, #00FFA3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .modal-btn {
            background: transparent;
            border: 2px solid #4D7EFF;
            border-radius: 60px;
            padding: 16px;
            width: 100%;
            margin: 8px 0;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn:hover {
            background: #4D7EFF;
        }
    </style>
</head>
<body>
    <!-- –ú–û–î–ê–õ–ö–ê –í–´–ë–û–†–ê –Ø–ó–´–ö–ê (–¢–û–õ–¨–ö–û –ü–†–ò –ü–ï–†–í–û–ú –ó–ê–•–û–î–ï) -->
    <div id="languageModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">üåç Choose language</div>
            <div class="modal-title" style="font-size: 18px; margin-top: -15px; -webkit-text-fill-color: white; background: none;">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</div>
            <button class="modal-btn" id="selectEnglish">üá∫üá∏ English</button>
            <button class="modal-btn" id="selectRussian">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
        </div>
    </div>
    
    <!-- HEADER -->
    <div class="header">
        <div class="logo">
            <span>REF</span><span>TON</span>
        </div>
        <div class="balance">
            <div class="balance-icon">‚Çø</div>
            <span class="balance-amount" id="balanceDisplay">0</span>
            <span class="balance-small" id="usdDisplay">‚âà$0</span>
        </div>
    </div>
    
    <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <div class="nav-grid">
        <div class="nav-item active" data-section="ads">
            <div class="nav-icon">üì∫</div>
            <div data-i18n="nav.ads">ADS</div>
        </div>
        <div class="nav-item" data-section="referrals">
            <div class="nav-icon">üë•</div>
            <div data-i18n="nav.ref">REF</div>
        </div>
        <div class="nav-item" data-section="profile">
            <div class="nav-icon">üë§</div>
            <div data-i18n="nav.profile">PROFILE</div>
        </div>
        <div class="nav-item" data-section="leaderboard">
            <div class="nav-icon">üèÜ</div>
            <div data-i18n="nav.top">TOP</div>
        </div>
    </div>
    
    <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –° –†–ê–ó–î–ï–õ–ê–ú–ò -->
    <div class="section-container">
        <!-- ADS -->
        <div id="adsSection" class="section active">
            <div class="glass-card">
                <img src="https://i.postimg.cc/QxQR12PR/ads.png" alt="Ads" class="section-image">
                
                <h3 style="margin-bottom: 20px; text-align: center;" data-i18n="ads.title">üì∫ Watch Ads & Earn</h3>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px; color: #8E9AB0;">
                    <span><span data-i18n="ads.today">Today</span>: <span id="dailyViews">0</span>/12</span>
                    <span id="cooldownDisplay" class="hidden"></span>
                </div>
                
                <div id="cooldownTimer" class="cooldown-timer hidden">
                    <span>‚è±Ô∏è</span>
                    <span id="timerSeconds">0</span>
                    <span data-i18n="ads.seconds">seconds until next ad</span>
                </div>
                
                <button class="refton-button" id="watchAdBtn">
                    <span>üé¨</span>
                    <span data-i18n="ads.watchBtn">Watch Ad & Earn 100 Coins</span>
                </button>
                
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="margin-bottom: 16px;" data-i18n="ads.dailyBonus">üéÅ Daily Bonus</h4>
                    <button class="refton-button-outline" style="width: 100%; padding: 12px;" id="dailyBonusBtn">
                        <span data-i18n="ads.claimBtn">Claim Daily Bonus</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- REFERRALS -->
        <div id="referralsSection" class="section">
            <div class="glass-card">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <img src="https://i.postimg.cc/rF1vxB36/referral.png" alt="Referral" style="width: 48px; height: 48px;">
                    <h3 data-i18n="ref.title">Your Referral Link</h3>
                </div>
                
                <div class="referral-link-box" id="referralLink">Loading...</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                    <button class="refton-button-outline" style="padding: 12px;" id="copyLinkBtn">
                        üìã <span data-i18n="ref.copy">Copy</span>
                    </button>
                    <button class="refton-button-outline" style="padding: 12px;" id="shareLinkBtn">
                        üì§ <span data-i18n="ref.share">Share</span>
                    </button>
                </div>
                
                <h4 style="margin-bottom: 16px;" data-i18n="ref.stats">üìä Your Stats</h4>
                <div style="background: rgba(0,0,0,0.2); border-radius: 16px; padding: 16px;">
                    <div class="stats-row">
                        <span data-i18n="ref.level1">Level 1 referrals</span>
                        <span style="font-weight: 600; color: #4D7EFF;" id="level1Count">0</span>
                    </div>
                    <div class="stats-row">
                        <span data-i18n="ref.level2">Level 2 referrals</span>
                        <span style="font-weight: 600; color: #00FFA3;" id="level2Count">0</span>
                    </div>
                    <div class="stats-row">
                        <span data-i18n="ref.earned">Earned from referrals</span>
                        <span style="font-weight: 600;" id="referralEarned">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PROFILE -->
        <div id="profileSection" class="section">
            <div class="glass-card">
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 24px;">
                    <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #4D7EFF, #00FFA3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üë§
                    </div>
                    <div>
                        <div style="font-size: 22px; font-weight: 600;" id="userName">User</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #8E9AB0;" data-i18n="profile.rank">Rank</span>
                            <span class="rank-badge rank-bronze" id="userRank">Bronze</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: 16px; padding: 16px;">
                    <div class="stats-row">
                        <span data-i18n="profile.totalEarned">Total earned</span>
                        <span style="font-weight: 600;" id="profileTotalEarned">0</span>
                    </div>
                    <div class="stats-row">
                        <span data-i18n="profile.totalReferrals">Total referrals</span>
                        <span style="font-weight: 600;" id="profileReferrals">0</span>
                    </div>
                    <div class="stats-row">
                        <span data-i18n="profile.totalViews">Total views</span>
                        <span style="font-weight: 600;" id="profileViews">0</span>
                    </div>
                    <div class="stats-row">
                        <span data-i18n="profile.joined">Joined</span>
                        <span style="font-weight: 600;" id="joinDate">Today</span>
                    </div>
                </div>
                
                <!-- –í–´–ë–û–† –Ø–ó–´–ö–ê -->
                <div class="language-selector">
                    <div class="lang-btn" id="langEn">üá∫üá∏ EN</div>
                    <div class="lang-btn" id="langRu">üá∑üá∫ RU</div>
                </div>
            </div>
        </div>
        
        <!-- LEADERBOARD -->
        <div id="leaderboardSection" class="section">
            <div class="glass-card">
                <h3 style="margin-bottom: 20px; text-align: center;" data-i18n="top.title">üèÜ Top Referrers</h3>
                
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; padding: 16px; background: rgba(77,126,255,0.1); border-radius: 16px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">ü•á</span>
                            <span style="font-weight: 600;">CryptoKing</span>
                        </div>
                        <span style="font-weight: 700; color: #4D7EFF;">1,234</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 16px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">ü•à</span>
                            <span style="font-weight: 600;">TONWhale</span>
                        </div>
                        <span style="font-weight: 700; color: #4D7EFF;">987</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">ü•â</span>
                            <span style="font-weight: 600;">BlockMaster</span>
                        </div>
                        <span style="font-weight: 700; color: #4D7EFF;">756</span>
                    </div>
                </div>
                
                <p style="text-align: center; color: #8E9AB0; font-size: 14px; margin-top: 20px;" data-i18n="top.more">More coming soon...</p>
            </div>
        </div>
    </div>
    
    <!-- TOAST -->
    <div id="toast" class="toast hidden"></div>
    
    <script>
        (function() {
            // ===== FIREBASE =====
            const firebaseConfig = {
                apiKey: "AIzaSyD2DVmirNOr3QYMTNmosl0SQYl_4fwTqfQ",
                authDomain: "refton-352c8.firebaseapp.com",
                projectId: "refton-352c8",
                storageBucket: "refton-352c8.firebasestorage.app",
                messagingSenderId: "230777778425",
                appId: "1:230777778425:web:deac18f7ba13e5cf5cb228",
                measurementId: "G-90P627XQC0"
            };
            
            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            
            // ===== TELEGRAM =====
            const Telegram = window.Telegram?.WebApp;
            if (Telegram) {
                Telegram.ready();
                Telegram.expand();
            }
            
            const TG_USER = Telegram?.initDataUnsafe?.user || { id: Date.now(), first_name: 'User' };
            const BOT_USERNAME = 'RefTON_bot'; // –ó–ê–ú–ï–ù–ò
            const DAILY_LIMIT = 12;
            const COOLDOWN_SECONDS = 35;
            const ADSGRAM_BLOCK_ID = 'YOUR_BLOCK_ID'; // –ó–ê–ú–ï–ù–ò
            
            // ===== –ö–£–†–°–´ =====
            const COIN_TO_USD = 0.001;
            const USD_TO_TON = 2.5;
            
            // ===== –ü–ï–†–ï–í–û–î–´ =====
            const translations = {
                en: {
                    'nav.ads': 'ADS',
                    'nav.ref': 'REF',
                    'nav.profile': 'PROFILE',
                    'nav.top': 'TOP',
                    'ads.title': 'üì∫ Watch Ads & Earn',
                    'ads.today': 'Today',
                    'ads.seconds': 'seconds until next ad',
                    'ads.watchBtn': 'Watch Ad & Earn 100 Coins',
                    'ads.dailyBonus': 'üéÅ Daily Bonus',
                    'ads.claimBtn': 'Claim Daily Bonus',
                    'ref.title': 'Your Referral Link',
                    'ref.copy': 'Copy',
                    'ref.share': 'Share',
                    'ref.stats': 'üìä Your Stats',
                    'ref.level1': 'Level 1 referrals',
                    'ref.level2': 'Level 2 referrals',
                    'ref.earned': 'Earned from referrals',
                    'profile.rank': 'Rank',
                    'profile.totalEarned': 'Total earned',
                    'profile.totalReferrals': 'Total referrals',
                    'profile.totalViews': 'Total views',
                    'profile.joined': 'Joined',
                    'top.title': 'üèÜ Top Referrers',
                    'top.more': 'More coming soon...'
                },
                ru: {
                    'nav.ads': '–†–ï–ö–õ–ê–ú–ê',
                    'nav.ref': '–†–ï–§–ï–†–ê–õ–´',
                    'nav.profile': '–ü–†–û–§–ò–õ–¨',
                    'nav.top': '–¢–û–ü',
                    'ads.title': 'üì∫ –°–º–æ—Ç—Ä–∏ —Ä–µ–∫–ª–∞–º—É –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π',
                    'ads.today': '–°–µ–≥–æ–¥–Ω—è',
                    'ads.seconds': '—Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥. —Ä–µ–∫–ª–∞–º—ã',
                    'ads.watchBtn': '–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É +100 –º–æ–Ω–µ—Ç',
                    'ads.dailyBonus': 'üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å',
                    'ads.claimBtn': '–ó–∞–±—Ä–∞—Ç—å –±–æ–Ω—É—Å',
                    'ref.title': '–¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞',
                    'ref.copy': '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
                    'ref.share': '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è',
                    'ref.stats': 'üìä –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                    'ref.level1': '–†–µ—Ñ–µ—Ä–∞–ª–æ–≤ 1 —É—Ä–æ–≤–Ω—è',
                    'ref.level2': '–†–µ—Ñ–µ—Ä–∞–ª–æ–≤ 2 —É—Ä–æ–≤–Ω—è',
                    'ref.earned': '–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤',
                    'profile.rank': '–†–∞–Ω–≥',
                    'profile.totalEarned': '–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ',
                    'profile.totalReferrals': '–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤',
                    'profile.totalViews': '–í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤',
                    'profile.joined': '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è',
                    'top.title': 'üèÜ –¢–æ–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤',
                    'top.more': '–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –±–æ–ª—å—à–µ...'
                }
            };
            
            // ===== –°–û–°–¢–û–Ø–ù–ò–ï =====
            let state = {
                user: {
                    id: TG_USER.id.toString(),
                    name: TG_USER.first_name || 'User',
                    coins: 0,
                    referralCode: `${TG_USER.id}_${Math.random().toString(36).substring(2, 8)}`,
                    referrals: { level1: [], level2: [] },
                    rank: 'bronze',
                    viewsToday: 0,
                    totalViews: 0,
                    totalEarned: 0,
                    joinDate: new Date().toISOString().split('T')[0],
                    language: null
                },
                cooldown: 0,
                timerInterval: null,
                currentLanguage: 'en'
            };
            
            // ===== –ü–ï–†–ï–í–û–î (–û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø) =====
            function applyLanguage(lang) {
                if (!lang || !translations[lang]) return;
                
                state.currentLanguage = lang;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å data-i18n
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —è–∑—ã–∫–∞
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (lang === 'en') {
                    document.getElementById('langEn').classList.add('active');
                } else {
                    document.getElementById('langRu').classList.add('active');
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
                if (state.user.id) {
                    db.collection('users').doc(state.user.id).update({
                        language: lang
                    }).catch(() => {});
                }
            }
            
            // ===== –ó–ê–ì–†–£–ó–ö–ê –ò–ó FIRESTORE =====
            async function loadUserFromFirestore() {
                try {
                    const docRef = db.collection('users').doc(state.user.id);
                    const docSnap = await docRef.get();
                    
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        state.user = { ...state.user, ...data };
                        
                        // –ï—Å–ª–∏ —è–∑—ã–∫ —É–∂–µ –≤—ã–±—Ä–∞–Ω - –ø—Ä–∏–º–µ–Ω—è–µ–º
                        if (data.language) {
                            applyLanguage(data.language);
                        } else {
                            // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                            document.getElementById('languageModal').style.display = 'flex';
                        }
                    } else {
                        // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                        document.getElementById('languageModal').style.display = 'flex';
                        
                        // –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ Firebase
                        await db.collection('users').doc(state.user.id).set({
                            ...state.user,
                            lastActive: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    updateUI();
                    
                } catch (error) {
                    console.error('Firestore error:', error);
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –∏–∑ localStorage
                    loadFromStorage();
                }
            }
            
            // ===== LOCAL STORAGE (—Ä–µ–∑–µ—Ä–≤) =====
            function loadFromStorage() {
                try {
                    const saved = localStorage.getItem('refton_user');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        state.user = { ...state.user, ...parsed };
                        
                        const lastDate = localStorage.getItem('refton_lastDate');
                        const today = new Date().toDateString();
                        if (lastDate !== today) {
                            state.user.viewsToday = 0;
                            localStorage.setItem('refton_lastDate', today);
                        }
                        
                        if (parsed.language) {
                            applyLanguage(parsed.language);
                        } else {
                            document.getElementById('languageModal').style.display = 'flex';
                        }
                    } else {
                        document.getElementById('languageModal').style.display = 'flex';
                    }
                } catch (e) {}
            }
            
            // ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –í FIRESTORE =====
            async function saveToFirestore() {
                try {
                    await db.collection('users').doc(state.user.id).set({
                        ...state.user,
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Firestore save error:', error);
                    // –†–µ–∑–µ—Ä–≤ –≤ localStorage
                    localStorage.setItem('refton_user', JSON.stringify(state.user));
                }
            }
            
            // ===== –†–ê–°–ß–ï–¢ –†–ê–ù–ì–ê =====
            function calculateRank(referralsCount) {
                if (referralsCount >= 100) return 'diamond';
                if (referralsCount >= 50) return 'platinum';
                if (referralsCount >= 20) return 'gold';
                if (referralsCount >= 5) return 'silver';
                return 'bronze';
            }
            
            // ===== ADSGRAM =====
            async function watchAd() {
                if (state.cooldown > 0) {
                    showToast(state.currentLanguage === 'en' ? `Please wait ${state.cooldown}s` : `–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${state.cooldown}—Å`);
                    return;
                }
                if (state.user.viewsToday >= DAILY_LIMIT) {
                    showToast(state.currentLanguage === 'en' ? 'Daily limit reached!' : '–õ–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è!');
                    return;
                }
                
                try {
                    const AdController = window.Adsgram.init({
                        blockId: ADSGRAM_BLOCK_ID,
                        debug: false
                    });
                    
                    await AdController.show();
                    
                    state.user.coins += 100;
                    state.user.viewsToday++;
                    state.user.totalViews++;
                    state.user.totalEarned += 100;
                    state.user.rank = calculateRank(state.user.referrals.level1.length);
                    
                    await saveToFirestore();
                    updateUI();
                    showToast(state.currentLanguage === 'en' ? '+100 coins!' : '+100 –º–æ–Ω–µ—Ç!');
                    startCooldown();
                    
                } catch (error) {
                    showToast(state.currentLanguage === 'en' ? 'Ad failed' : '–û—à–∏–±–∫–∞ —Ä–µ–∫–ª–∞–º—ã');
                }
            }
            
            function startCooldown() {
                state.cooldown = COOLDOWN_SECONDS;
                if (state.timerInterval) clearInterval(state.timerInterval);
                updateCooldownUI();
                
                state.timerInterval = setInterval(() => {
                    state.cooldown--;
                    updateCooldownUI();
                    if (state.cooldown <= 0) {
                        clearInterval(state.timerInterval);
                        state.timerInterval = null;
                        updateCooldownUI();
                    }
                }, 1000);
            }
            
            function updateCooldownUI() {
                const timerEl = document.getElementById('cooldownTimer');
                const secondsEl = document.getElementById('timerSeconds');
                const cooldownDisplay = document.getElementById('cooldownDisplay');
                
                if (state.cooldown > 0) {
                    timerEl.classList.remove('hidden');
                    cooldownDisplay.classList.remove('hidden');
                    if (secondsEl) secondsEl.textContent = state.cooldown;
                    if (cooldownDisplay) cooldownDisplay.textContent = `‚è±Ô∏è ${state.cooldown}s`;
                } else {
                    timerEl.classList.add('hidden');
                    cooldownDisplay.classList.add('hidden');
                }
            }
            
            // ===== –ï–ñ–ï–î–ù–ï–í–ù–´–ô –ë–û–ù–£–° =====
            async function claimDailyBonus() {
                const lastBonus = localStorage.getItem('lastBonus');
                const today = new Date().toDateString();
                
                if (lastBonus === today) {
                    showToast(state.currentLanguage === 'en' ? 'Already claimed!' : '–£–∂–µ –∑–∞–±—Ä–∞–ª!');
                    return;
                }
                
                state.user.coins += 50;
                localStorage.setItem('lastBonus', today);
                await saveToFirestore();
                updateUI();
                showToast(state.currentLanguage === 'en' ? '+50 bonus!' : '+50 –±–æ–Ω—É—Å!');
            }
            
            // ===== –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–°–´–õ–ö–ê =====
            function getReferralLink() {
                return `https://t.me/${BOT_USERNAME}?start=${state.user.referralCode}`;
            }
            
            // ===== UI –û–ë–ù–û–í–õ–ï–ù–ò–ï =====
            function updateUI() {
                // –ë–∞–ª–∞–Ω—Å
                document.getElementById('balanceDisplay').textContent = state.user.coins;
                const usdValue = (state.user.coins * COIN_TO_USD).toFixed(2);
                const tonValue = (usdValue * USD_TO_TON).toFixed(2);
                document.getElementById('usdDisplay').textContent = `‚âà$${usdValue} / ${tonValue} TON`;
                
                // ADS
                document.getElementById('dailyViews').textContent = state.user.viewsToday;
                
                // Referrals
                document.getElementById('level1Count').textContent = state.user.referrals.level1.length;
                document.getElementById('level2Count').textContent = state.user.referrals.level2.length;
                const referralEarned = state.user.referrals.level1.length * 20 + state.user.referrals.level2.length * 10;
                document.getElementById('referralEarned').textContent = referralEarned;
                document.getElementById('referralLink').textContent = getReferralLink();
                
                // Profile
                document.getElementById('userName').textContent = state.user.name;
                const rankEl = document.getElementById('userRank');
                rankEl.textContent = state.user.rank.charAt(0).toUpperCase() + state.user.rank.slice(1);
                rankEl.className = `rank-badge rank-${state.user.rank}`;
                document.getElementById('profileTotalEarned').textContent = state.user.totalEarned;
                document.getElementById('profileReferrals').textContent = state.user.referrals.level1.length;
                document.getElementById('profileViews').textContent = state.user.totalViews;
                document.getElementById('joinDate').textContent = new Date(state.user.joinDate).toLocaleDateString();
            }
            
            function showToast(msg) {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 2000);
            }
            
            // ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø =====
            function setupEventListeners() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                        item.classList.add('active');
                        
                        const section = item.dataset.section;
                        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                        document.getElementById(section + 'Section').classList.add('active');
                    });
                });
                
                document.getElementById('watchAdBtn').addEventListener('click', watchAd);
                document.getElementById('dailyBonusBtn').addEventListener('click', claimDailyBonus);
                
                document.getElementById('copyLinkBtn').addEventListener('click', () => {
                    navigator.clipboard.writeText(getReferralLink());
                    showToast(state.currentLanguage === 'en' ? 'Copied!' : '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
                });
                
                document.getElementById('shareLinkBtn').addEventListener('click', () => {
                    const text = encodeURIComponent(state.currentLanguage === 'en' 
                        ? 'Join RefTON and earn crypto with referrals! üöÄ' 
                        : '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ RefTON –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –∫—Ä–∏–ø—Ç—É —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏! üöÄ');
                    const url = encodeURIComponent(getReferralLink());
                    window.open(`https://t.me/share/url?url=${url}&text=${text}`);
                });
                
                // ===== –í–´–ë–û–† –Ø–ó–´–ö–ê (—Ä–∞–±–æ—Ç–∞–µ—Ç!) =====
                document.getElementById('langEn').addEventListener('click', () => {
                    applyLanguage('en');
                    state.user.language = 'en';
                    saveToFirestore();
                });
                
                document.getElementById('langRu').addEventListener('click', () => {
                    applyLanguage('ru');
                    state.user.language = 'ru';
                    saveToFirestore();
                });
                
                // –í—ã–±–æ—Ä —è–∑—ã–∫–∞ –≤ –º–æ–¥–∞–ª–∫–µ
                document.getElementById('selectEnglish').addEventListener('click', () => {
                    applyLanguage('en');
                    state.user.language = 'en';
                    saveToFirestore();
                    document.getElementById('languageModal').style.display = 'none';
                });
                
                document.getElementById('selectRussian').addEventListener('click', () => {
                    applyLanguage('ru');
                    state.user.language = 'ru';
                    saveToFirestore();
                    document.getElementById('languageModal').style.display = 'none';
                });
            }
            
            // ===== –°–¢–ê–†–¢ =====
            loadUserFromFirestore();
            setupEventListeners();
        })();
    </script>
</body>
                        </html>
